<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBO Analysis System</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Helvetica', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .input-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 15px;
            font-size: 1.1em;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-analyze {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .results-section {
            margin-top: 30px;
        }
        
        .level-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .level-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-weight: bold;
            font-size: 1.3em;
        }
        
        .level-content {
            padding: 20px;
        }
        
        .shareholder-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }
        
        .shareholder-item.personal {
            border-left-color: #28a745;
        }
        
        .shareholder-item.company {
            border-left-color: #007bff;
        }

        .hierarchy-tree-container {
            width: 100%;
            height: 1200px;
            overflow: auto;
            padding: 10px;
            background: #f8fbff;
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            position: relative;
        }

        .hierarchy-tree-container svg {
            font-family: 'Inter', 'Helvetica', 'Arial', sans-serif;
        }

        .tree-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            font-size: 0.85em;
            color: #425466;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tree-legend span {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .legend-swatch {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(17, 24, 39, 0.25);
            display: inline-block;
            flex-shrink: 0;
        }

        .legend-swatch.company {
            background: #1f77b4;
        }

        .legend-swatch.personal {
            background: #4CAF50;
        }

        .legend-swatch.ubo {
            background: #EF4444;
            border-color: #991B1B;
        }

        .accordion.level-accordion .accordion-button {
            background: linear-gradient(45deg, rgba(102,126,234,0.15), rgba(118,75,162,0.15));
            font-weight: 600;
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .accordion.level-accordion .accordion-button.collapsed {
            background: #f8fafc;
            color: #374151;
        }

        .accordion.level-accordion .accordion-button:focus {
            box-shadow: none;
            border-color: rgba(102,126,234,0.4);
        }

        .level-badge {
            background: rgba(59,130,246,0.12);
            color: #1d4ed8;
            border-radius: 999px;
            padding: 3px 10px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .shareholder-body {
            background: #f9fafb;
        }
        
        .shareholder-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .shareholder-percentage {
            font-size: 0.95em;
            font-weight: 600;
            color: #4C51BF;
        }
        
        .shareholder-type {
            font-size: 0.8em;
            color: #6b7280;
        }

        .shareholder-item .btn {
            min-width: 120px;
            font-size: 0.78em;
        }

        .shareholder-ubo-detail {
            background: #f4f7ff;
            border-radius: 10px;
            border: 1px solid rgba(99,102,241,0.25);
            font-size: 0.85em;
            color: #334155;
        }
        
        .ubo-section {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .ubo-item {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #667eea;
        }
        
        .summary-stats {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .investigation-item {
            background: #f0f9ff;
            border-left: 4px solid #1e40af;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
        }
        
        .investigation-item h6 {
            color: #1e3a8a;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .investigation-item .badge {
            font-size: 0.75em;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header">
                <h1><img src="{{ url_for('static', filename='icon/LHB_Logo.png') }}" alt="LHB" style="width: 50px; height: 50px; margin-right: 12px; vertical-align: middle;"> LH Bank UBO Analysis System</h1>
                <p>Ultimate Beneficial Owner (UBO) verification dashboard</p>
            </div>
            
            <!-- Input Section -->
            <div class="input-section">
                <div class="row">
                    <div class="col-md-8">
                        <label for="registrationId" class="form-label">
                            <i class="fas fa-building"></i> Company Registration ID
                        </label>
                        <input type="text" class="form-control" id="registrationId" 
                               placeholder="e.g., 0107548000234" value="0107548000234">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-analyze w-100" onclick="analyzeUBO()">
                            <i class="fas fa-play"></i> Analyze UBO
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Loading -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Analyzing...</span>
                </div>
                <p class="mt-3">Analyzing UBO data...</p>
            </div>
            
            <!-- Results Section -->
            <div id="results" class="results-section" style="display: none;">
                <!-- Company Info -->
                <div class="level-card">
                    <div class="level-header">
                        <i class="fas fa-building"></i> Main Company Information
                    </div>
                    <div class="level-content" id="companyInfo">
                        <!-- Company info will be populated here -->
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="summary-stats">
                    <div class="row" id="summaryStats">
                        <!-- Summary stats will be populated here -->
                    </div>
                </div>
                
                <!-- UBO Results -->
                <div class="ubo-section" id="uboSection">
                    <h3><i class="fas fa-crown"></i> UBO Analysis Results</h3>
                    <div id="uboResults">
                        <!-- UBO results will be populated here -->
                    </div>
                </div>
                
                <!-- Companies Requiring Further Investigation -->
                <div class="level-card" id="investigationSection" style="display: none;">
                    <div class="level-header" style="background: linear-gradient(45deg, #1e3a8a, #1e40af);">
                        <i class="fas fa-exclamation-triangle"></i> Companies Requiring Further Investigation
                    </div>
                    <div class="level-content">
                        <p class="text-muted mb-3">
                            <i class="fas fa-info-circle"></i> These companies have <strong>no shareholder data available</strong> from the API. 
                            They may be foreign companies, institutions, or companies where data could not be retrieved. Manual verification required.
                        </p>
                        <div id="investigationResults">
                            <!-- Investigation companies will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Hierarchy Tree -->
                <div class="level-card">
                    <div class="level-header">
                        <i class="fas fa-sitemap"></i> Shareholding Structure
                    </div>
                    <div class="level-content">
                        <h5 class="text-secondary fw-semibold mb-3">Shareholding Network</h5>
                        
                        <!-- Entity Filter Dropdowns -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-user"></i> Filter by Individual:</label>
                                <select id="individualFilter" class="form-select form-select-sm">
                                    <option value="">-- All Individuals --</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold"><i class="fas fa-building"></i> Filter by Company:</label>
                                <select id="companyFilter" class="form-select form-select-sm">
                                    <option value="">-- All Companies --</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Center Level Selector -->
                        <div class="text-center mb-3">
                            <div id="levelSelector" class="btn-group btn-group-sm" role="group" aria-label="Level selector">
                                <!-- Level buttons will be added dynamically -->
                            </div>
                        </div>
                        
                        <div id="hierarchyTree" class="hierarchy-tree-container" style="position: relative;">
                            <!-- Legend will be positioned inside the container -->
                        </div>
                    </div>
                </div>

                <!-- Shareholder Levels -->
                <div class="level-card">
                    <div class="level-header">
                        <i class="fas fa-layer-group"></i> Shareholder Details by Level
                    </div>
                    <div class="level-content">
                        <div class="accordion level-accordion" id="levelAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingLevel1">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#level1Collapse" aria-expanded="false" aria-controls="level1Collapse">
                                        <span><i class="fas fa-layer-group me-2"></i> Level 1 - Direct Shareholders</span>
                                        <span class="level-badge" id="level1Badge">0</span>
                                    </button>
                                </h2>
                                <div id="level1Collapse" class="accordion-collapse collapse" aria-labelledby="headingLevel1" data-bs-parent="#levelAccordion">
                                    <div class="accordion-body shareholder-body" id="level1Content"></div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingLevel2">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#level2Collapse" aria-expanded="false" aria-controls="level2Collapse">
                                        <span><i class="fas fa-layer-group me-2"></i> Level 2 - Indirect Shareholders</span>
                                        <span class="level-badge" id="level2Badge">0</span>
                                    </button>
                                </h2>
                                <div id="level2Collapse" class="accordion-collapse collapse" aria-labelledby="headingLevel2" data-bs-parent="#levelAccordion">
                                    <div class="accordion-body shareholder-body" id="level2Content"></div>
                                </div>
                            </div>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingLevel3">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#level3Collapse" aria-expanded="false" aria-controls="level3Collapse">
                                        <span><i class="fas fa-layer-group me-2"></i> Level 3 - Third-tier Shareholders</span>
                                        <span class="level-badge" id="level3Badge">0</span>
                                    </button>
                                </h2>
                                <div id="level3Collapse" class="accordion-collapse collapse" aria-labelledby="headingLevel3" data-bs-parent="#levelAccordion">
                                    <div class="accordion-body shareholder-body" id="level3Content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function analyzeUBO() {
            const registrationId = document.getElementById('registrationId').value.trim();
            
            if (!registrationId) {
                alert('Please enter a company registration ID.');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ registration_id: registrationId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayResults(result.data);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
            }
        }
        
        function displayResults(data) {
            // Display company info
            displayCompanyInfo(data.company_info);
            
            // Display summary stats
            displaySummaryStats(data);
            
            // Display level details
            displayLevelDetails(data.hierarchy_data);
            
            // Display UBO results
            displayUBOResults(data.ubos);
            
            // Display companies requiring investigation
            displayInvestigationCompanies(data.hierarchy_data);
            
            // Display network graph (NEW: Interactive spider-web visualization)
            if (data.network_graph && data.network_graph.nodes && data.network_graph.nodes.length > 0) {
                renderNetworkGraph(data.network_graph);
            } else {
                // Fallback to tree diagram
                renderHierarchyTree(data.tree_structure);
            }
        }

        function formatNameWithId(name, regisId) {
            const cleanName = (name || '').trim();
            const cleanId = (regisId || '').trim();
            if (cleanId) {
                if (cleanName) {
                    return cleanName.includes(cleanId) ? cleanName : `${cleanName} (${cleanId})`;
                }
                return cleanId;
            }
            return cleanName || 'Unknown';
        }
        
        function displayCompanyInfo(companyInfo) {
            const html = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Company Name:</strong> ${companyInfo.display_name || companyInfo.name_en || 'Unknown'}</p>
                        <p><strong>Business Type:</strong> ${companyInfo.business_type || 'Unknown'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Registration ID:</strong> ${companyInfo.regis_id || 'Unknown'}</p>
                        <p><strong>Status:</strong> ${companyInfo.status || 'Unknown'}</p>
                        <p><strong>Registered Capital:</strong> ${companyInfo.capital || 'Unknown'}</p>
                        <p><strong>Registration Date:</strong> ${companyInfo.regis_date || 'Unknown'}</p>
                        <p><strong>Analysis Time:</strong> ${companyInfo.check_date || 'Unknown'}</p>
                    </div>
                </div>
            `;
            document.getElementById('companyInfo').innerHTML = html;
        }
        
        function displaySummaryStats(data) {
            const hierarchyData = data.hierarchy_data || {};
            const ubos = data.ubos || [];
            
            // Count by level
            const levelCounts = {1: 0, 2: 0, 3: 0};
            const typeCounts = {personal: 0, company: 0};
            
            Object.values(hierarchyData).forEach(company => {
                const level = company.level || 0;
                const shareholders = company.shareholders || [];
                
                // Shareholders of level 0 company are Level 1
                // Shareholders of level 1 companies are Level 2
                // Shareholders of level 2 companies are Level 3
                const displayLevel = level + 1;
                
                if (displayLevel >= 1 && displayLevel <= 3) {
                    levelCounts[displayLevel] += shareholders.length;
                }
                
                shareholders.forEach(sh => {
                    const type = sh.shareholder_type || 'personal';
                    if (typeCounts[type] !== undefined) {
                        typeCounts[type]++;
                    }
                });
            });
            
            const uboCount = ubos.filter(ubo => ubo.total_percentage >= 15).length;
            
            const html = `
                <div class="col-md-3">
                    <div class="stat-item">
                        <div class="stat-number">${levelCounts[1]}</div>
                        <div class="stat-label">Level 1</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <div class="stat-number">${levelCounts[2]}</div>
                        <div class="stat-label">Level 2</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <div class="stat-number">${levelCounts[3]}</div>
                        <div class="stat-label">Level 3</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <div class="stat-number">${uboCount}</div>
                        <div class="stat-label">UBO (≥15%)</div>
                    </div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = html;
        }
        
        function displayLevelDetails(hierarchyData) {
            // Group by level
            const levelData = {1: [], 2: [], 3: []};
            
            Object.values(hierarchyData).forEach(company => {
                const level = company.level || 0;
                const shareholders = company.shareholders || [];
                
                // Shareholders of level 0 company are Level 1
                // Shareholders of level 1 companies are Level 2
                // Shareholders of level 2 companies are Level 3
                const displayLevel = level + 1;
                
                if (displayLevel >= 1 && displayLevel <= 3) {
                    const companyLabel = formatNameWithId(
                        company.display_name || company.name_en || company.name_th || 'Not specified',
                        company.company_id || ''
                    );
                    shareholders.forEach(sh => {
                        levelData[displayLevel].push({
                            ...sh,
                            company_name: companyLabel
                        });
                    });
                }
            });
            
            const collapseConfig = {
                1: {collapseId: 'level1Collapse', badgeId: 'level1Badge'},
                2: {collapseId: 'level2Collapse', badgeId: 'level2Badge'},
                3: {collapseId: 'level3Collapse', badgeId: 'level3Badge'}
            };

            let expanded = false;
            for (let level = 1; level <= 3; level++) {
                const aggregated = aggregateShareholders(levelData[level]);
                displayLevelContent(level, aggregated);

                const cfg = collapseConfig[level];
                const badgeEl = document.getElementById(cfg.badgeId);
                if (badgeEl) {
                    badgeEl.textContent = aggregated.length;
                }

                const collapseEl = document.getElementById(cfg.collapseId);
                const buttonEl = document.querySelector(`button[data-bs-target="#${cfg.collapseId}"]`);
                if (!collapseEl || !buttonEl) continue;

                const collapseInstance = bootstrap.Collapse.getOrCreateInstance(collapseEl, {toggle: false});
                if (!expanded && aggregated.length > 0) {
                    collapseInstance.show();
                    buttonEl.classList.remove('collapsed');
                    buttonEl.setAttribute('aria-expanded', 'true');
                    expanded = true;
                } else {
                    collapseInstance.hide();
                    buttonEl.classList.add('collapsed');
                    buttonEl.setAttribute('aria-expanded', 'false');
                }
            }
        }

        function aggregateShareholders(shareholders) {
            const itemMap = new Map();

            shareholders.forEach(sh => {
                const regis = (sh.regis_id || sh.regis_id_held_by || '').trim();
                const baseName = sh.display_name || `${(sh.firstname || '')} ${(sh.lastname || '')}`.trim() || 'Unknown';
                const label = formatNameWithId(baseName, regis);
                const key = regis ? `regis:${regis}` : `name:${label.toUpperCase()}`;

        if (!itemMap.has(key)) {
            itemMap.set(key, {
                label,
                regisId: regis,
                type: sh.shareholder_type || 'personal',
                company_name: sh.company_name || 'Not specified',
                direct: 0,
                effective: 0,
                entries: []
            });
        }

        const entry = itemMap.get(key);
        entry.type = entry.type === 'company' || sh.shareholder_type === 'company' ? 'company' : 'personal';
        const directContribution = parseFloat(sh.direct_percent ?? sh.percent ?? 0) || 0;
        const effectiveContribution = parseFloat(sh.effective_percentage || sh.effective || sh.percent || 0) || 0;
        // ✅ FIX: ใช้ direct % จาก API ตรงๆ ไม่บวก (เอาค่าแรกหรือค่าสูงสุด)
        if (entry.entries.length === 0) {
            entry.direct = directContribution;
        }
        // Effective ยังคงบวกเพื่อ UBO calculation
        entry.effective += effectiveContribution;
        entry.entries.push({
            direct: directContribution,
            effective: effectiveContribution,
            factors: (sh.ubo_factors || []).map(val => parseFloat(val || 0)),
            pathSteps: (sh.ubo_path || []).map(step => ({
                name: step.entity_name || 'Unknown',
                id: step.entity_id || '',
                percent: parseFloat(step.share_percent || 0) || 0
            })),
            raw: sh
        });
            });

        return Array.from(itemMap.values())
            .sort((a, b) => b.direct - a.direct);
        }
        
        function displayLevelContent(level, shareholders) {
            const containerId = `level${level}Content`;
            const container = document.getElementById(containerId);
            
            if (shareholders.length === 0) {
                container.innerHTML = '<p class="text-muted">No shareholder data for this level.</p>';
                return;
            }
            
            // Group by company
            const companyGroups = {};
            shareholders.forEach(sh => {
                const companyName = sh.company_name || 'Not specified';
                if (!companyGroups[companyName]) {
                    companyGroups[companyName] = [];
                }
                companyGroups[companyName].push(sh);
            });
            
            let html = '';
            Object.entries(companyGroups).forEach(([companyName, shs]) => {
                html += `
                    <div class="mb-3">
                        <h6 class="text-primary"><i class="fas fa-building"></i> ${companyName}</h6>
                        <div class="row">
                `;
                
                shs.forEach((sh, idx) => {
                    const directShare = parseFloat(sh.direct || 0).toFixed(2);
                    const effectiveShare = parseFloat(sh.effective || sh.direct || 0).toFixed(2);
                    const type = sh.type || 'personal';
                    const typeClass = type === 'personal' ? 'personal' : 'company';
                    const typeIcon = type === 'personal' ? 'fas fa-user' : 'fas fa-building';
                    const typeText = type === 'personal' ? 'Individual' : 'Company';
                    const detailId = `shareholderDetail-${level}-${companyName.replace(/[^a-zA-Z0-9]/g, '')}-${idx}`;
                    const detailItems = (sh.entries || []).map((entry, entryIdx) => {
                        const factorTexts = (entry.factors || []).map(val => `${(parseFloat(val) || 0).toFixed(2)}%`);
                        const pathNames = (entry.pathSteps || []).map(step => formatNameWithId(step.name, step.id)).join(' → ');
                        const directText = `${(entry.direct || 0).toFixed(2)}%`;
                        const effectiveText = `${(entry.effective || 0).toFixed(2)}%`;
                        
                        // ✅ Show UBO calculation with full multiplication and result
                        let uboCalcDisplay = '';
                        if (factorTexts.length > 0) {
                            uboCalcDisplay = `<span class="badge bg-info">${factorTexts.join(' × ')} = ${effectiveText}</span>`;
                        } else {
                            uboCalcDisplay = effectiveText;
                        }
                        
                        return `<li class="mb-2">
                            <strong>Path ${entryIdx + 1}:</strong> ${pathNames || 'N/A'}<br>
                            <span class="text-muted">Direct Share: ${directText}</span><br>
                            <span class="text-primary">UBO Effect: ${uboCalcDisplay}</span>
                        </li>`;
                    }).join('');
                    
                    // ✅ แสดง UBO Effect ในการ์ดหลัก
                    const percentDisplay = directShare !== effectiveShare 
                        ? `${directShare}% <span class="text-muted small">(UBO Effect: ${effectiveShare}%)</span>`
                        : `${directShare}%`;
                    
                    html += `
                        <div class="col-md-6 mb-2">
                            <div class="shareholder-item ${typeClass}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="shareholder-name">
                                            <i class="${typeIcon}"></i> ${sh.label}
                                        </div>
                                        <div class="shareholder-percentage">${percentDisplay}</div>
                                        <div class="shareholder-type">${typeText}</div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#${detailId}" aria-expanded="false" aria-controls="${detailId}">
                                        View UBO Calc
                                    </button>
                                </div>
                                <div class="collapse mt-2" id="${detailId}">
                                    <div class="card card-body shareholder-ubo-detail">
                                            <p class="mb-2"><strong>Direct share:</strong> ${directShare}%</p>
                                            <p class="mb-2"><strong>Effective holding (UBO):</strong> ${effectiveShare}%</p>
                                            <p class="mb-2 text-muted">Derived from ${sh.entries.length} path(s)</p>
                                            <ul class="mb-0 ps-3 small text-secondary">${detailItems || '<li>No detailed path data.</li>'}</ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function displayUBOResults(ubos) {
            const container = document.getElementById('uboResults');
            const uboSection = document.getElementById('uboSection');
            
            if (!ubos || ubos.length === 0) {
                container.innerHTML = '<p>No UBO met the ≥15% threshold.</p>';
                // ✅ เปลี่ยนเป็นสีเขียวเมื่อไม่มี UBO
                uboSection.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                return;
            }
            
            // Sort by percentage
            const sortedUbos = ubos.sort((a, b) => b.total_percentage - a.total_percentage);
            const qualifiedUbos = sortedUbos.filter(ubo => ubo.total_percentage >= 15);
            
            if (qualifiedUbos.length === 0) {
                container.innerHTML = '<p>No UBO met the ≥15% threshold.</p>';
                // ✅ เปลี่ยนเป็นสีเขียวเมื่อไม่มี UBO
                uboSection.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                return;
            }
            
            // ✅ มี UBO ให้ใช้สีแดง (เดิม)
            uboSection.style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';
            
            let html = '';
            qualifiedUbos.forEach((ubo, index) => {
                const percentage = parseFloat(ubo.total_percentage).toFixed(2);
                const pathDetails = ubo.path_details || [];
                const pathsCount = ubo.paths_count || pathDetails.length || 0;
                
                // Build path calculation details
                let pathDetailsHtml = '';
                if (pathDetails.length > 0) {
                    pathDetailsHtml = '<div class="mt-3"><h6>UBO Calculation Details (All Paths):</h6><ol class="mb-0" style="font-size: 0.9em;">';
                    pathDetails.forEach((detail, i) => {
                        pathDetailsHtml += `
                            <li class="mb-2">
                                <strong>Path ${i + 1}:</strong> ${detail.names ? detail.names.join(' → ') : 'N/A'}<br>
                                <span class="badge bg-info">${detail.calculation || 'N/A'}</span>
                            </li>
                        `;
                    });
                    // Show total calculation
                    const pathSums = pathDetails.map(d => `${d.result.toFixed(3)}%`).join(' + ');
                    pathDetailsHtml += `</ol><div class="mt-2 p-2" style="background: rgba(255,255,255,0.3); border-radius: 8px;"><strong>Total UBO Effect:</strong> ${pathSums} = <strong>${percentage}%</strong></div></div>`;
                }
                
                const detailId = `uboDetail-${index}`;
                html += `
                    <div class="ubo-item">
                        <h5><i class="fas fa-crown"></i> UBO #${index + 1}</h5>
                        <p><strong>Name:</strong> ${ubo.name || 'Unknown'}</p>
                        <p><strong>Total Shareholding:</strong> ${percentage}% <span class="badge bg-light text-dark">${pathsCount} paths</span></p>
                        <p><strong>Identification Method:</strong> ${ubo.identification_method || 'Method 1'}</p>
                        <p><strong>Nationality:</strong> ${ubo.nationality || 'Unknown'}</p>
                        <p><strong>Director:</strong> ${ubo.is_director ? 'Yes' : 'No'}</p>
                        ${pathDetails.length > 0 ? `
                        <button class="btn btn-sm btn-light mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#${detailId}">
                            <i class="fas fa-calculator"></i> View Calculation Details
                        </button>
                        <div class="collapse mt-2" id="${detailId}">
                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;">
                                ${pathDetailsHtml}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function displayInvestigationCompanies(hierarchyData) {
            const container = document.getElementById('investigationResults');
            const section = document.getElementById('investigationSection');
            
            if (!hierarchyData) {
                section.style.display = 'none';
                return;
            }
            
            // Find companies with NO shareholders at all (API couldn't find data)
            // These are typically level 1 or 2 companies (not level 0 main company)
            const investigationCompanies = [];
            
            Object.values(hierarchyData).forEach(company => {
                const level = company.level || 0;
                const shareholders = company.shareholders || [];
                const companyType = company.type || 'company';
                
                // Check if it's a company (not main) with ZERO shareholders
                // This means API could not retrieve shareholder data for this company
                if (level > 0 && level <= 2 && companyType !== 'personal') {
                    // If NO shareholders at all, it's an investigation company
                    if (shareholders.length === 0) {
                        investigationCompanies.push({
                            name: company.display_name || company.name_en || company.name_th || company.company_id,
                            company_id: company.company_id,
                            level: level,
                            total_shareholders: 0,
                            personal_shareholders: 0
                        });
                    }
                }
            });
            
            if (investigationCompanies.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            // Sort by level
            investigationCompanies.sort((a, b) => a.level - b.level);
            
            section.style.display = 'block';
            
            let html = '';
            investigationCompanies.forEach((company, index) => {
                html += `
                    <div class="investigation-item">
                        <h6>
                            <i class="fas fa-building"></i> ${company.name}
                            <span class="badge bg-primary ms-2">Level ${company.level}</span>
                        </h6>
                        <p class="mb-2 text-muted small">
                            <strong>Company ID:</strong> ${company.company_id || 'N/A'}
                        </p>
                        <p class="mb-0 text-danger small fw-bold">
                            <i class="fas fa-exclamation-triangle"></i> No shareholder data available
                        </p>
                        <p class="mb-0 small" style="color: #1e40af;">
                            <i class="fas fa-exclamation-circle"></i> <strong>Action Required:</strong> API could not retrieve shareholder data. 
                            This may be a foreign company or institution. Manual verification required.
                        </p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function truncateLabel(label, max = 26) {
            if (!label) return '';
            return label.length > max ? label.slice(0, max - 3) + '...' : label;
        }

        function renderHierarchyTree(treeData) {
            const container = d3.select('#hierarchyTree');
            container.selectAll('*').remove();

            if (!treeData || Object.keys(treeData).length === 0) {
                container.append('p')
                    .attr('class', 'text-muted')
                    .text('No hierarchy data available.');
                return;
            }

            const root = d3.hierarchy(treeData, d => d.children || []);
            const dx = 70;
            const dy = 280;
            const treeLayout = d3.tree().nodeSize([dx, dy]).separation((a, b) => (a.parent === b.parent ? 1.6 : 2.4));
            const BOX_WIDTH = 240;
            const BOX_HEIGHT = 78;
            treeLayout(root);

            let x0 = Infinity;
            let x1 = -Infinity;
            root.each(d => {
                if (d.x > x1) x1 = d.x;
                if (d.x < x0) x0 = d.x;
            });

            const width = Math.max(1024, (root.height + 1) * dy + BOX_WIDTH * 2.5);
            const height = x1 - x0 + dx * 2.5;

            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', [0, x0 - dx * 1.5, width, height])
                .attr('style', 'max-width: 100%; height: auto; font: 12px "Inter", sans-serif;');

            const g = svg.append('g').attr('transform', 'translate(200,0)');

            g.append('g')
                .attr('fill', 'none')
                .attr('stroke', '#CBD5F0')
                .attr('stroke-width', 1.6)
                .attr('stroke-linecap', 'round')
                .selectAll('path')
                .data(root.links())
                .join('path')
                .attr('d', d => {
                    const sourceX = d.source.x;
                    const sourceY = d.source.y + BOX_WIDTH / 2;
                    const targetX = d.target.x;
                    const targetY = d.target.y - BOX_WIDTH / 2;
                    const midY = (sourceY + targetY) / 2;
                    return `M${sourceY},${sourceX}C${midY},${sourceX} ${midY},${targetX} ${targetY},${targetX}`;
                });

            const node = g.append('g')
                .selectAll('g')
                .data(root.descendants())
                .join('g')
                .attr('transform', d => `translate(${d.y},${d.x})`);

            node.append('rect')
                .attr('x', -(BOX_WIDTH / 2))
                .attr('y', -(BOX_HEIGHT / 2))
                .attr('width', BOX_WIDTH)
                .attr('height', BOX_HEIGHT)
                .attr('rx', 12)
                .attr('fill', d => {
                    if (d.data.isUbo) return '#EF4444';
                    return d.data.type === 'company' ? '#1f77b4' : '#4CAF50';
                })
                .attr('fill-opacity', d => (d.data.isUbo ? 0.95 : 0.85))
                .attr('stroke', d => d.data.isUbo ? '#991B1B' : 'rgba(17,24,39,0.28)')
                .attr('stroke-width', d => d.data.isUbo ? 2.2 : 1.2)
                .attr('filter', 'drop-shadow(0px 1px 2px rgba(15, 23, 42, 0.12))');

            node.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', -6)
                .attr('fill', '#F8FAFC')
                .attr('font-weight', 600)
                .attr('font-size', '10px')
                .text(d => truncateLabel(d.data.name || 'Unknown', 32));

            node.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', 12)
                .attr('fill', '#E0ECFF')
                .attr('font-size', '10px')
                .text(d => {
                    const direct = parseFloat(d.data.direct_percent || 0);
                    return `Share: ${direct.toFixed(2)}%`;
                });

            node.append('title')
                .text(d => {
                    const direct = parseFloat(d.data.direct_percent || 0);
                    const effective = parseFloat(d.data.effective_percent || direct);
                    const typeText = d.data.type ? d.data.type.toUpperCase() : 'UNKNOWN';
                    const uboText = d.data.isUbo ? '\nUBO Candidate (≥15%)' : '';
                    return `${d.data.name || 'Unknown'}\nType: ${typeText}\nDirect Share: ${direct.toFixed(4)}%\nEffective Holding: ${effective.toFixed(4)}%${uboText}`;
                });
        }
        
        // Global state for network graph
        let currentGraphData = null;
        let currentSimulation = null;
        let currentSelectedEntity = null;
        
        function populateFilterDropdowns(graphData) {
            const individualFilter = document.getElementById('individualFilter');
            const companyFilter = document.getElementById('companyFilter');
            
            // Clear existing options (except first "All" option)
            individualFilter.innerHTML = '<option value="">-- All Individuals --</option>';
            companyFilter.innerHTML = '<option value="">-- All Companies --</option>';
            
            // Get unique individuals and companies
            const individuals = new Set();
            const companies = new Set();
            
            graphData.nodes.forEach(node => {
                if (node.type === 'personal') {
                    individuals.add(node.full_name);
                } else if (node.type === 'company' && node.level > 0) {
                    companies.add(node.full_name);
                }
            });
            
            // Populate dropdowns (sorted)
            Array.from(individuals).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                individualFilter.appendChild(option);
            });
            
            Array.from(companies).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                companyFilter.appendChild(option);
            });
            
            // Add event listeners
            individualFilter.addEventListener('change', function() {
                if (this.value) {
                    companyFilter.value = ''; // Clear other filter
                    highlightEntity(this.value);
                } else {
                    clearHighlight();
                }
            });
            
            companyFilter.addEventListener('change', function() {
                if (this.value) {
                    individualFilter.value = ''; // Clear other filter
                    highlightEntity(this.value);
                } else {
                    clearHighlight();
                }
            });
        }
        
        function renderNetworkGraph(graphData) {
            const container = d3.select('#hierarchyTree');
            container.selectAll('*').remove();
            
            if (!graphData || !graphData.nodes || graphData.nodes.length === 0) {
                container.append('p').attr('class', 'text-muted').text('No network data available.');
                return;
            }
            
            // Store graph data globally
            currentGraphData = graphData;
            
            // Populate filter dropdowns
            populateFilterDropdowns(graphData);
            
            // ✅ Create Level Selector
            const maxLevel = d3.max(graphData.nodes, d => d.level) || 3;
            const levelSelector = document.getElementById('levelSelector');
            let selectedMaxLevel = maxLevel; // Show all levels by default
            
            let levelBtns = '<button class="btn btn-sm btn-outline-primary active" data-level="all">All Levels</button>';
            for (let i = 1; i <= maxLevel; i++) {
                levelBtns += `<button class="btn btn-sm btn-outline-primary" data-level="${i}">Level 0-${i}</button>`;
            }
            levelSelector.innerHTML = levelBtns;
            
            // Level selector event handler
            levelSelector.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', function() {
                    levelSelector.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const level = this.getAttribute('data-level');
                    selectedMaxLevel = level === 'all' ? maxLevel : parseInt(level);
                    
                    // Filter and update visibility
                    node.style('display', d => d.level <= selectedMaxLevel ? 'block' : 'none');
                    nodeLabel.style('display', d => d.level <= selectedMaxLevel ? 'block' : 'none');
                    
                    // Filter edges based on visible nodes
                    link.style('display', d => {
                        const sourceLevel = typeof d.source === 'object' ? d.source.level : 
                                          graphData.nodes.find(n => n.id === d.source)?.level || 0;
                        const targetLevel = typeof d.target === 'object' ? d.target.level : 
                                          graphData.nodes.find(n => n.id === d.target)?.level || 0;
                        return (sourceLevel <= selectedMaxLevel && targetLevel <= selectedMaxLevel) ? 'block' : 'none';
                    });
                    
                    linkLabel.style('display', d => {
                        const sourceLevel = typeof d.source === 'object' ? d.source.level : 
                                          graphData.nodes.find(n => n.id === d.source)?.level || 0;
                        const targetLevel = typeof d.target === 'object' ? d.target.level : 
                                          graphData.nodes.find(n => n.id === d.target)?.level || 0;
                        return (sourceLevel <= selectedMaxLevel && targetLevel <= selectedMaxLevel) ? 'block' : 'none';
                    });
                });
            });
            
            const width = Math.max(1200, container.node().getBoundingClientRect().width);
            const height = 1200; // Larger height for better network visualization
            
            const svg = container.append('svg')
                .attr('width', '100%')
                .attr('height', height)
                .attr('viewBox', [0, 0, width, height])
                .attr('style', 'max-width: 100%; height: auto; background: #ffffff; border: 1px solid #e5e7eb;');
            
            const g = svg.append('g');
            
            svg.call(d3.zoom().scaleExtent([0.1, 4]).on('zoom', e => g.attr('transform', e.transform)));
            
            const maxCapital = d3.max(graphData.nodes, d => d.capital) || 1;
            const nodeScale = d3.scaleSqrt().domain([0, maxCapital]).range([10, 45]);
            // More pronounced line thickness difference: 10% = 2.5px, 20% = 5px, 50% = 12.5px
            const linkWidthScale = d3.scaleLinear().domain([0, 100]).range([1.5, 18]);
            
            // Low gravity forces for maximum node freedom and distribution
            const simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.edges).id(d => d.id)
                    .distance(d => 250 - (d.percent * 0.8)) // Longer distance for more spread
                    .strength(0.3)) // Weaker link force
                .force('charge', d3.forceManyBody().strength(-900).distanceMax(600)) // Lower repulsion for smooth movement
                .force('center', d3.forceCenter(width / 2, height / 2).strength(0.005)) // Very minimal centering
                .force('collision', d3.forceCollide()
                    .radius(d => nodeScale(d.capital) + 50) // Large collision radius
                    .strength(0.8)) // Lower collision prevention for smoother drag
                .force('x', d3.forceX(width / 2).strength(d => d.level === 0 ? 0.15 : 0.005)) // Minimal pull to center
                .force('y', d3.forceY(height / 2).strength(d => d.level === 0 ? 0.15 : 0.005))
                .force('radial', d3.forceRadial(d => d.level * 220, width / 2, height / 2).strength(d => d.level === 0 ? 0 : 0.15)) // Weaker radial distribution
                .alphaDecay(0.02) // Slower cooling for better settling
                .velocityDecay(0.2); // Less friction for smoother movement
            
            // Fixed-size arrow marker (doesn't scale with line thickness)
            svg.append('defs').selectAll('marker').data(['arrow']).join('marker')
                .attr('id', 'arrow').attr('viewBox', '0 -4 10 8').attr('refX', 28).attr('refY', 0)
                .attr('markerWidth', 4).attr('markerHeight', 4).attr('orient', 'auto')
                .attr('markerUnits', 'userSpaceOnUse') // Fixed size regardless of stroke width
                .append('path').attr('d', 'M0,-3L10,0L0,3').attr('fill', '#6b7280');
            
            // Identify UBO nodes
            const uboNodeIds = new Set(graphData.nodes.filter(n => n.is_ubo).map(n => n.id));
            
            // Identify investigation nodes (companies with NO shareholders at all - API couldn't find data)
            const investigationNodeIds = new Set();
            graphData.nodes.forEach(node => {
                if (node.type === 'company' && node.level > 0 && node.level <= 2) {
                    // Check if this node has ANY outgoing edges at all (to anyone - company or individual)
                    const hasAnyChildren = graphData.edges.some(edge => {
                        const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                        return sourceId === node.id;
                    });
                    
                    // If NO children at all, it means API couldn't find shareholder data
                    if (!hasAnyChildren) {
                        investigationNodeIds.add(node.id);
                    }
                }
            });
            
            // Mark edges that lead to UBO nodes (recursively find all paths to UBOs)
            const uboPathEdges = new Set();
            function markUBOPaths(nodeId, visited = new Set()) {
                if (visited.has(nodeId)) return false;
                visited.add(nodeId);
                
                if (uboNodeIds.has(nodeId)) return true;
                
                const outgoingEdges = graphData.edges.filter(e => e.target === nodeId || e.target.id === nodeId);
                for (const edge of outgoingEdges) {
                    const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                    if (markUBOPaths(sourceId, new Set(visited))) {
                        uboPathEdges.add(edge);
                        return true;
                    }
                }
                return false;
            }
            
            // Mark all UBO paths
            uboNodeIds.forEach(uboId => markUBOPaths(uboId));
            
            // Store link and node references globally for highlighting
            window.networkGraphElements = window.networkGraphElements || {};
            
            const link = g.append('g').selectAll('line').data(graphData.edges).join('line')
                .attr('stroke', d => uboPathEdges.has(d) ? '#DC2626' : '#6b7280') // Red for UBO paths
                .attr('stroke-opacity', d => uboPathEdges.has(d) ? 0.9 : 0.7)
                .attr('marker-end', 'url(#arrow)').attr('stroke-width', d => linkWidthScale(d.percent))
                .attr('class', 'graph-link');
            
            const linkLabel = g.append('g').selectAll('text').data(graphData.edges).join('text')
                .attr('fill', '#374151').attr('font-size', '10px').attr('font-weight', '600')
                .attr('text-anchor', 'middle').attr('dy', -5)
                .text(d => `${d.percent.toFixed(1)}%`)
                .attr('class', 'graph-link-label');
            
            const node = g.append('g').selectAll('circle').data(graphData.nodes).join('circle')
                .attr('r', d => nodeScale(d.capital))
                .attr('fill', d => {
                    if (d.level === 0) return '#1f2937'; // Main company = black
                    if (d.is_ubo) return '#EF4444'; // UBO = red
                    if (d.type === 'personal') return '#10b981'; // Personal = green
                    if (investigationNodeIds.has(d.id)) return '#1e40af'; // Investigation = deep blue
                    return '#3b82f6'; // Company = blue
                })
                .attr('stroke', d => {
                    if (d.level === 0) return '#000000'; // Main company black stroke
                    if (d.is_ubo) return '#991b1b'; // UBO red stroke
                    if (investigationNodeIds.has(d.id)) return '#f59e0b'; // Investigation = orange stroke (highlight)
                    return '#fff';
                })
                .attr('stroke-width', d => {
                    if (d.level === 0) return 4; // Main company thicker stroke
                    if (d.is_ubo) return 3;
                    if (investigationNodeIds.has(d.id)) return 3; // Investigation nodes thicker stroke
                    return 2;
                })
                .style('cursor', 'pointer')
                .call(d3.drag()
                    .on('start', e => { if (!e.active) simulation.alphaTarget(0.3).restart(); e.subject.fx = e.subject.x; e.subject.fy = e.subject.y; })
                    .on('drag', e => { e.subject.fx = e.x; e.subject.fy = e.y; })
                    .on('end', e => { if (!e.active) simulation.alphaTarget(0); e.subject.fx = null; e.subject.fy = null; }));
            
            const nodeLabel = g.append('g').selectAll('text').data(graphData.nodes).join('text')
                .attr('fill', '#1f2937').attr('font-size', '11px').attr('font-weight', '600')
                .attr('text-anchor', 'middle').attr('dy', d => nodeScale(d.capital) + 18).text(d => d.name)
                .attr('class', 'graph-node-label');
            
            // Store references for highlighting
            window.networkGraphElements = {
                nodes: node,
                nodeLabels: nodeLabel,
                links: link,
                linkLabels: linkLabel,
                simulation: simulation,
                graphData: graphData,
                uboPathEdges: uboPathEdges,
                investigationNodeIds: investigationNodeIds,
                nodeScale: nodeScale,
                linkWidthScale: linkWidthScale
            };
            
            const tooltip = d3.select('body').append('div').style('position', 'absolute').style('background', 'rgba(255,255,255,0.98)')
                .style('border', '2px solid #3b82f6').style('border-radius', '8px').style('padding', '12px')
                .style('color', '#1f2937').style('font-size', '13px').style('pointer-events', 'none')
                .style('opacity', 0).style('max-width', '320px').style('box-shadow', '0 4px 12px rgba(0,0,0,0.15)').style('z-index', 10000);
            
            node.on('mouseover', (e, d) => {
                const isInvestigation = investigationNodeIds.has(d.id);
                tooltip.html(`<div style="font-weight:600;color:#60a5fa;margin-bottom:8px;font-size:14px;">${d.full_name}</div>
                    <div><strong>Type:</strong> ${d.type === 'personal' ? 'Individual' : 'Company'}</div>
                    ${d.regis_id ? `<div><strong>ID:</strong> ${d.regis_id}</div>` : ''}
                    ${d.capital > 0 ? `<div><strong>Capital:</strong> ฿${d.capital.toLocaleString()}</div>` : ''}
                    ${d.is_ubo ? '<div style="color:#ef4444;"><strong>✅ UBO (≥15%)</strong></div>' : ''}
                    ${isInvestigation ? '<div style="color:#1e40af;"><strong>⚠️ Requires Investigation</strong></div>' : ''}
                    <div><strong>Level:</strong> ${d.level}</div>`)
                .style('left', (e.pageX + 15) + 'px').style('top', (e.pageY + 15) + 'px').style('opacity', 1);
                d3.select(e.currentTarget).transition().duration(200).attr('stroke-width', 5).attr('r', d => nodeScale(d.capital) * 1.2);
            }).on('mouseout', (e, d) => {
                tooltip.style('opacity', 0);
                const isInvestigation = investigationNodeIds.has(d.id);
                const strokeWidth = d.level === 0 ? 4 : (d.is_ubo || isInvestigation ? 3 : 2);
                d3.select(e.currentTarget).transition().duration(200).attr('stroke-width', strokeWidth).attr('r', d => nodeScale(d.capital));
            });
            
            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                linkLabel.attr('x', d => (d.source.x + d.target.x) / 2).attr('y', d => (d.source.y + d.target.y) / 2);
                node.attr('cx', d => d.x).attr('cy', d => d.y);
                nodeLabel.attr('x', d => d.x).attr('y', d => d.y);
            });
            
            // ✅ Add Legend to the container
            const legendHTML = `
                <div class="tree-legend">
                    <span><span class="legend-swatch" style="background: #1f2937;"></span> Main Company</span>
                    <span><span class="legend-swatch" style="background: #3b82f6;"></span> Company</span>
                    <span><span class="legend-swatch" style="background: #1e40af; border: 2px solid #f59e0b;"></span> Investigation Needed</span>
                    <span><span class="legend-swatch" style="background: #10b981;"></span> Individual</span>
                    <span><span class="legend-swatch" style="background: #EF4444;"></span> UBO ≥ 15%</span>
                    <span><span class="legend-swatch" style="background: #DC2626; border: none; height: 3px; margin-top: 6px;"></span> UBO Path</span>
                </div>
            `;
            document.getElementById('hierarchyTree').insertAdjacentHTML('beforeend', legendHTML);
        }
        
        // Highlighting functions for entity filtering
        function highlightEntity(entityName) {
            if (!window.networkGraphElements) return;
            
            const elements = window.networkGraphElements;
            const graphData = elements.graphData;
            
            // Find ALL nodes with matching name (person may appear multiple times)
            const selectedNodes = graphData.nodes.filter(n => n.full_name === entityName);
            if (selectedNodes.length === 0) return;
            
            currentSelectedEntity = entityName;
            
            // Find ONLY paths from selected entity TO main company (root)
            const connectedNodes = new Set();
            const connectedEdges = new Set();
            
            // Add all instances of the selected person/company
            selectedNodes.forEach(node => connectedNodes.add(node.id));
            
            // Find the main company (level 0)
            const mainCompany = graphData.nodes.find(n => n.level === 0);
            if (!mainCompany) {
                console.warn('Main company not found');
                return;
            }
            
            // Find all paths from selected node to main company
            // Direction: selected node -> ... -> main company
            function findPathsToMain(currentId, visited = new Set()) {
                if (visited.has(currentId)) return false;
                visited.add(currentId);
                
                // Reached main company
                if (currentId === mainCompany.id) {
                    return true;
                }
                
                let foundPath = false;
                
                // Find all edges where current node is SOURCE (going outward to main)
                graphData.edges.forEach(edge => {
                    const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                    const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                    
                    // Only follow edges FROM current node (shareholder -> company direction)
                    if (sourceId === currentId) {
                        const newVisited = new Set(visited);
                        if (findPathsToMain(targetId, newVisited)) {
                            // This edge is part of a path to main
                            connectedEdges.add(edge);
                            connectedNodes.add(sourceId);
                            connectedNodes.add(targetId);
                            foundPath = true;
                        }
                    }
                });
                
                return foundPath;
            }
            
            // Find paths from ALL instances of the selected person/company
            selectedNodes.forEach(node => {
                findPathsToMain(node.id);
            });
            
            // Apply STRONG highlighting - connected elements very visible
            const investigationIds = elements.investigationNodeIds || new Set();
            
            // Check if node is one of the selected nodes
            const isSelectedNode = (nodeId) => selectedNodes.some(n => n.id === nodeId);
            
            elements.nodes
                .style('opacity', d => connectedNodes.has(d.id) ? 1 : 0.1)
                .attr('stroke-width', d => {
                    if (isSelectedNode(d.id)) return 6; // Selected entity - very thick border
                    if (!connectedNodes.has(d.id)) return 0.5; // Very thin for faded
                    // Connected nodes - emphasize with thicker borders
                    if (d.level === 0) return 5;
                    if (d.is_ubo || investigationIds.has(d.id)) return 4;
                    return 3;
                })
                .attr('stroke', d => {
                    if (isSelectedNode(d.id)) return '#f59e0b'; // Bright orange for selected
                    if (!connectedNodes.has(d.id)) return '#e5e7eb'; // Very light for faded
                    // Emphasize connected nodes with bright borders
                    if (d.level === 0) return '#000000';
                    if (d.is_ubo) return '#991b1b';
                    if (investigationIds.has(d.id)) return '#f59e0b';
                    return '#ffffff'; // Bright white border for connected nodes
                })
                .attr('filter', d => {
                    // Add glow effect to connected nodes
                    if (connectedNodes.has(d.id)) {
                        return 'drop-shadow(0px 0px 8px rgba(59, 130, 246, 0.6))';
                    }
                    return 'none';
                });
            
            elements.nodeLabels
                .style('opacity', d => connectedNodes.has(d.id) ? 1 : 0.1)
                .attr('font-weight', d => {
                    if (isSelectedNode(d.id)) return '900'; // Extra bold for selected
                    if (connectedNodes.has(d.id)) return '700'; // Bold for connected
                    return '600';
                })
                .attr('font-size', d => {
                    if (isSelectedNode(d.id)) return '13px'; // Bigger for selected
                    if (connectedNodes.has(d.id)) return '12px'; // Bigger for connected
                    return '11px';
                })
                .attr('fill', d => connectedNodes.has(d.id) ? '#111827' : '#d1d5db');
            
            // Check if selected entity is a UBO
            const isSelectedUBO = selectedNodes.some(n => n.is_ubo === true);
            
            // HIGHLIGHT connected paths with much more visibility
            elements.links
                .style('opacity', d => connectedEdges.has(d) ? 1 : 0.03)
                .attr('stroke-width', d => {
                    if (!connectedEdges.has(d)) return 0.3; // Very thin faded lines
                    // Connected edges - make MUCH thicker and more visible
                    const baseWidth = elements.linkWidthScale ? elements.linkWidthScale(d.percent) : 2;
                    return baseWidth * 2.5; // Much thicker
                })
                .attr('stroke', d => {
                    if (!connectedEdges.has(d)) return '#f3f4f6'; // Almost invisible gray for faded
                    // HIGHLIGHT connected paths: 
                    // If selected person is UBO, show all their paths in RED
                    if (isSelectedUBO) {
                        return '#DC2626'; // RED for UBO person's paths
                    }
                    // Otherwise, keep original logic
                    if (elements.uboPathEdges && elements.uboPathEdges.has(d)) {
                        return '#DC2626'; // Red for UBO paths
                    }
                    return '#3b82f6'; // Bright blue for regular paths
                });
            
            elements.linkLabels
                .style('opacity', d => connectedEdges.has(d) ? 1 : 0)
                .attr('font-weight', d => connectedEdges.has(d) ? '800' : '600')
                .attr('font-size', d => connectedEdges.has(d) ? '12px' : '10px')
                .attr('fill', d => connectedEdges.has(d) ? '#1f2937' : '#9ca3af');
        }
        
        function clearHighlight() {
            if (!window.networkGraphElements) return;
            
            currentSelectedEntity = null;
            const elements = window.networkGraphElements;
            const investigationIds = elements.investigationNodeIds || new Set();
            
            // Reset all elements to default state
            elements.nodes
                .style('opacity', 1)
                .attr('stroke-width', d => {
                    if (d.level === 0) return 4;
                    if (d.is_ubo || investigationIds.has(d.id)) return 3;
                    return 2;
                })
                .attr('stroke', d => {
                    if (d.level === 0) return '#000000';
                    if (d.is_ubo) return '#991b1b';
                    if (investigationIds.has(d.id)) return '#f59e0b';
                    return '#fff';
                })
                .attr('filter', 'none'); // Remove glow effect
            
            elements.nodeLabels
                .style('opacity', 1)
                .attr('font-weight', '600')
                .attr('font-size', '11px')
                .attr('fill', '#1f2937');
            
            elements.links
                .style('opacity', d => elements.uboPathEdges && elements.uboPathEdges.has(d) ? 0.9 : 0.7)
                .attr('stroke-width', d => elements.linkWidthScale ? elements.linkWidthScale(d.percent) : 2)
                .attr('stroke', d => elements.uboPathEdges && elements.uboPathEdges.has(d) ? '#DC2626' : '#6b7280');
            
            elements.linkLabels
                .style('opacity', 1)
                .attr('font-weight', '600')
                .attr('font-size', '10px')
                .attr('fill', '#374151');
        }
        
        // Auto-focus on input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('registrationId').focus();
        });
    </script>
</body>
</html>