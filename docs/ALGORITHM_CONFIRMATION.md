# ‚úÖ Algorithm Confirmation - 3-Tier Shareholding Analysis

## üéØ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥

### Queue-Based BFS Traversal

```
Start: Main Company (Level 0) - 100%
         |
         ‚Üì
    [Queue Processing]
```

---

## üìä 3 Tiers Explained

### **Tier 1 (Level 1)**
**‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API:** `levelHeldBy level="1"` ‡∏Ç‡∏≠‡∏á **Main Company**

```
Main Company (0107548000234)
    ‚îú‚îÄ Personal Shareholder A: 30% ‚Üí ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô UBO candidates
    ‚îú‚îÄ Personal Shareholder B: 20% ‚Üí ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô UBO candidates  
    ‚îú‚îÄ Company X (regis_id): 25% ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Queue
    ‚îú‚îÄ Company Y (regis_id): 15% ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Queue
    ‚îî‚îÄ Company Z (regis_id): 10% ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Queue
                                    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                                    ‡∏£‡∏ß‡∏°: 100%
```

**‚úÖ Yes:** ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô Level 1 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á Main Company ‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô = 100%

---

### **Tier 2 (Level 2)**
**‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API:** `levelHeldBy level="1"` ‡∏Ç‡∏≠‡∏á **‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô Tier 1**

```
Company X (‡∏à‡∏≤‡∏Å Tier 1, ‡∏ñ‡∏∑‡∏≠ 25%)
    ‚îú‚îÄ Personal Shareholder C: 50% ‚Üí effective = 25% √ó 50% = 12.5%
    ‚îú‚îÄ Personal Shareholder D: 30% ‚Üí effective = 25% √ó 30% = 7.5%
    ‚îî‚îÄ Company M (regis_id): 20% ‚Üí effective = 25% √ó 20% = 5%, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Queue
                                   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                                   ‡∏£‡∏ß‡∏°: 100% (‡∏Ç‡∏≠‡∏á Company X)

Company Y (‡∏à‡∏≤‡∏Å Tier 1, ‡∏ñ‡∏∑‡∏≠ 15%)
    ‚îú‚îÄ Personal Shareholder E: 60% ‚Üí effective = 15% √ó 60% = 9%
    ‚îú‚îÄ Company N (regis_id): 30% ‚Üí effective = 15% √ó 30% = 4.5%, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Queue
    ‚îî‚îÄ Personal Shareholder F: 10% ‚Üí effective = 15% √ó 10% = 1.5%
                                    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                                    ‡∏£‡∏ß‡∏°: 100% (‡∏Ç‡∏≠‡∏á Company Y)

Company Z (‡∏à‡∏≤‡∏Å Tier 1, ‡∏ñ‡∏∑‡∏≠ 10%)
    ‚îú‚îÄ Personal Shareholder G: 80% ‚Üí effective = 10% √ó 80% = 8%
    ‚îî‚îÄ Personal Shareholder H: 20% ‚Üí effective = 10% √ó 20% = 2%
                                    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                                    ‡∏£‡∏ß‡∏°: 100% (‡∏Ç‡∏≠‡∏á Company Z)
```

**‚úÖ Yes:** ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô Level 1 ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏ô Tier 2 ‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô = 100%

---

### **Tier 3 (Level 3)**
**‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API:** `levelHeldBy level="1"` ‡∏Ç‡∏≠‡∏á **‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô Tier 2**

```
Company M (‡∏à‡∏≤‡∏Å Tier 2, effective 5%)
    ‚îú‚îÄ Personal Shareholder I: 70% ‚Üí effective = 5% √ó 70% = 3.5%
    ‚îî‚îÄ Personal Shareholder J: 30% ‚Üí effective = 5% √ó 30% = 1.5%
                                    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                                    ‡∏£‡∏ß‡∏°: 100% (‡∏Ç‡∏≠‡∏á Company M)

Company N (‡∏à‡∏≤‡∏Å Tier 2, effective 4.5%)
    ‚îú‚îÄ Personal Shareholder K: 90% ‚Üí effective = 4.5% √ó 90% = 4.05%
    ‚îî‚îÄ Personal Shareholder L: 10% ‚Üí effective = 4.5% √ó 10% = 0.45%
                                    ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                                    ‡∏£‡∏ß‡∏°: 100% (‡∏Ç‡∏≠‡∏á Company N)
```

**‚úÖ Yes:** ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô Level 1 ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏ô Tier 3 ‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô = 100%

**‚õî Stop:** ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà Level 3 (‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡πà Tier 4)

---

## ‚úÖ Confirmation

### ‚úÖ ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥ (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)

1. **Tier 1:** ‡πÄ‡∏≠‡∏≤ Level 1 shareholders ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á Main Company
2. **Tier 2:** ‡πÄ‡∏≠‡∏≤ Level 1 shareholders ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á **‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó** ‡∏à‡∏≤‡∏Å Tier 1
3. **Tier 3:** ‡πÄ‡∏≠‡∏≤ Level 1 shareholders ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á **‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó** ‡∏à‡∏≤‡∏Å Tier 2

### ‚úÖ ‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏° 100%

**‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£:**
- ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô Level 1 ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô = **100%** (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á)
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 100% ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞:
  1. **API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö** (HTTP 500 error, timeout, missing data)
  2. **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á API ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå**
  3. **‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏ö‡∏≤‡∏á‡∏Ñ‡∏ô‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ threshold ‡∏ó‡∏µ‡πà API ‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ** (‡πÄ‡∏ä‡πà‡∏ô < 0.1%)

---

## üîç Algorithm Code Flow

```python
# Initialize
processing_queue = deque([(main_company_id, 100.0, 0, [])])

while processing_queue:
    current_company_id, current_percentage, current_level, path_chain = processing_queue.popleft()
    
    # Stop at Level 3 (max_levels = 4 means levels 0-3)
    if current_level >= 4:
        break
    
    # Get Level 1 shareholders ‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    company_data = api_client.get_company_data(current_company_id)
    shareholders = company_data.get('shareholders', [])  # Level 1 only
    
    for shareholder in shareholders:
        direct_percent = shareholder['percent']  # % ‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡πÉ‡∏ô current_company
        effective_percent = current_percentage * (direct_percent / 100.0)
        
        if shareholder['type'] == 'personal':
            # ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô UBO candidates
            ubo_results[shareholder['name']].total_percentage += effective_percent
        
        elif shareholder['type'] == 'company':
            # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ Queue ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ï‡πà‡∏≠
            processing_queue.append((
                shareholder['regis_id'],
                effective_percent,
                current_level + 1,
                path_chain + [shareholder]
            ))
```

---

## üìã Summary

| Tier | Level | API Call | Output |
|------|-------|----------|--------|
| Main | 0 | - | ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏´‡∏•‡∏±‡∏Å (100%) |
| Tier 1 | 1 | `levelHeldBy level="1"` ‡∏Ç‡∏≠‡∏á Main | ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á Main (‡∏£‡∏ß‡∏° 100%) |
| Tier 2 | 2 | `levelHeldBy level="1"` ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏≤‡∏Å Tier 1 | ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏£‡∏ß‡∏° 100% ‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó) |
| Tier 3 | 3 | `levelHeldBy level="1"` ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏≤‡∏Å Tier 2 | ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏£‡∏ß‡∏° 100% ‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó) |

---

## ‚úÖ Confirmed

**‡πÉ‡∏ä‡πà‡∏Ñ‡∏£‡∏±‡∏ö! Algorithm ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:**

1. ‚úÖ ‡∏ó‡∏≥ 3 Tiers
2. ‚úÖ ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏≠‡∏î‡πÄ‡∏≠‡∏≤ Level 1 ‡∏Ç‡∏≠‡∏á Tree ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
3. ‚úÖ ‡∏Ñ‡∏ß‡∏£‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô 100% ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏ñ‡πâ‡∏≤ API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö)

---

**Note:** ‡∏ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô 100% ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:
1. API response ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
2. ‡∏°‡∏µ HTTP error (500, 404) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
3. ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà API ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ñ‡∏∑‡∏≠‡∏´‡∏∏‡πâ‡∏ô‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ

